<!DOCTYPE html>
<html lang="pt-br" data-bs-theme="dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard do J3M</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-notify/0.2.0/css/bootstrap-notify.min.css" rel="stylesheet">
    <style type="text/css">
        #overlay {
            position: fixed;
            display: block;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(58, 50, 50, 0.5);
            z-index: 2;
            cursor: pointer;
        }

        .overlay-text {
            position: absolute;
            top: 50%;
            left: 50%;
        }

        .overlay-hidden {
            display: none !important;
        }

        .success-color {
            background-color: #198754 !important;
        }

        .warning-color {
            background-color: #ffc107 !important;
        }

        .danger-color {
            background-color: #dc3545 !important;
        }
    </style>
  </head>
  <body>
    <main>
        <div class="container">
            <div class="row">
                <h1 class="text-center">Dashboard do J3M</h1>
                <hr/>
                <div class="col-sm-4">
                    <div class="form-group">
                        <label for="sensor_id">ID do J3M:</label>
                        <select id="sensor_id" name="sensor_id" class="form-control">
                            <option value="" selected="">Todos os Sensores</option>
                        </select>
                    </div>
                </div>

                <div class="col-sm-4">
                    <div class="form-group">
                        <label for="date">Data:</label>
                        <input type="text" id="date" name="date" class="form-control datepicker">
                    </div>
                </div>

                <div class="col-sm-4">
                    <div class="form-group">
                        <br/>
                        <button type="button" class="btn btn-primary btn-filter"><i class="fa fa-search"></i>&nbsp; Filtrar</button>
                    </div>
                </div>
            </div>

            <hr/>

            <div class="condicao-alert alert" role="alert">
                <h3 class="condicao">Não há dados</h3>
            </div>

            <hr/>

            <div class="row justify-content-md-center">
                <div class="col-sm-6 col-md-2">
                    <div class="card mb-3 smoke-avg-card">
                        <div class="card-body">
                          <h5 class="card-title">Fumaça</h5>
                          <p class="card-text smoke-avg">Não há dados</p>
                        </div>
                    </div>
                </div>

                <div class="col-sm-6 col-md-2">
                    <div class="card mb-3 humidity-avg-card">
                        <div class="card-body">
                          <h5 class="card-title">Umidade</h5>
                          <p class="card-text humidity-avg">Não há dados</p>
                        </div>
                    </div>
                </div>

                <div class="col-sm-6 col-md-2">
                    <div class="card mb-3 co-avg-card">
                        <div class="card-body">
                          <h5 class="card-title">Monóxido de Carbono</h5>
                          <p class="card-text co-avg">Não há dados</p>
                        </div>
                    </div>
                </div>

                <div class="col-sm-6 col-md-2">
                    <div class="card mb-3 temperature-avg-card">
                        <div class="card-body">
                          <h5 class="card-title">Temperatura</h5>
                          <p class="card-text temperature-avg">Não há dados</p>
                        </div>
                    </div>
                </div>

                <div class="col-sm-6 col-md-2">
                    <div class="card mb-3 co2-avg-card">
                        <div class="card-body">
                          <h5 class="card-title">Dióxido de Carbono</h5>
                          <p class="card-text co2-avg">Não há dados</p>
                        </div>
                    </div>
                </div>
            </div>

            <hr/>

            <div class="row">
                <div class="col-sm-4">
                    <h4>Fumaça</h4>
                    <div class="progress" role="progressbar" aria-label="Success example" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" style="height: 30px">
                        <div class="progress-bar progress-bar-striped overflow-visible progress-smoke" style="width: 0%"></div>
                    </div>
                </div>

                <div class="col-sm-4">
                    <h4>Umidade</h4>
                    <div class="progress" role="progressbar" aria-label="Success example" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" style="height: 30px">
                        <div class="progress-bar progress-bar-striped overflow-visible progress-humidity" style="width: 0%"></div>
                    </div>
                </div>

                <div class="col-sm-4">
                    <h4>Monóxido de Carbono</h4>
                    <div class="progress" role="progressbar" aria-label="Success example" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" style="height: 30px">
                        <div class="progress-bar progress-bar-striped overflow-visible progress-co" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <br/>

            <div class="row">
                <div class="col-sm-4">
                    <h4>Temperatura</h4>
                    <div class="progress" role="progressbar" aria-label="Success example" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" style="height: 30px">
                        <div class="progress-bar progress-bar-striped overflow-visible progress-temperature" style="width: 0%"></div>
                    </div>
                </div>

                <div class="col-sm-4">
                    <h4>Dióxido de Carbono</h4>
                    <div class="progress" role="progressbar" aria-label="Success example" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" style="height: 30px">
                        <div class="progress-bar progress-bar-striped overflow-visible progress-co2" style="width: 0%"></div>
                    </div>
                </div>

                <div class="col-sm-4">
                    <h4>Legendas</h4>
                    <table class="table table-responsive">
                        <tbody>
                            <tr>
                                <td class="text-light success-color"><i class="fa fa-check"></i>&nbsp; Bom</td>
                                <td>Métrica em condição boa</td>
                            </tr>

                            <tr>
                                <td class="text-dark warning-color"><i class="fa fa-warning"></i>&nbsp; Moderado</td>
                                <td>Métrica em condição moderada</td>
                            </tr>

                            <tr>
                                <td class="text-light danger-color"><i class="fa fa-times"></i>&nbsp; Ruim</td>
                                <td>Métrica em condição ruim</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="overlay" class="overlay-hidden">
            <i class="fa-solid fa-rotate fa-spin fa-10x overlay-text"></i>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-notify@3.1.3/bootstrap-notify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script type="text/javascript">
        $.notifyDefaults({
            z_index: 100000
        });

        $(document).ready(function () {
            $.ajax({
                contentType: 'application/json',
                method: 'GET',
                url: 'http://18.214.175.44:8080/api/users/arduinos',
                timeout: 0,
                success: function (response) {
                    let sensors = response.data;

                    for (let s in sensors) {
                        $('#sensor_id').append(`<option value=${sensors[s].id}>${sensors[s].name}</option>`);
                    }

                },
                error: function (err) {
                    console.error(error);
                }
            });
        });

        $('.datepicker').daterangepicker({
            ranges: {
                'Hoje': [moment(), moment()],
                'Ontem': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                'Últimos 7 Dias': [moment().subtract(6, 'days'), moment()],
                'Últimos 30 Dias': [moment().subtract(29, 'days'), moment()],
                'Esse Mês': [moment().startOf('month'), moment().endOf('month')],
                'Último Mês': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
            },
            locale: {
                format: "YYYY-MM-DD",
                separator: " até ",
                applyLabel: "Aplicar",
                cancelLabel: "Cancelar",
                fromLabel: "De",
                toLabel: "Para",
                customRangeLabel: "Customizar",
                weekLabel: "S",
                daysOfWeek: [
                    "Dom",
                    "Seg",
                    "Ter",
                    "Qua",
                    "Qui",
                    "Sex",
                    "Sab"
                ],
                monthNames: [
                    "Janeiro",
                    "Fevereiro",
                    "Março",
                    "Abril",
                    "Maio",
                    "Junho",
                    "Julho",
                    "Agosto",
                    "Setembro",
                    "Outubro",
                    "Novembro",
                    "Dezembro"
                ],
                firstDay: 1
            },
        }, function(start, end, label) {});

        $('.btn-filter').on('click', function () {
            $('#overlay').removeClass('overlay-hidden');

            let idArduino = $('#sensor_id').val() ?? null;
            let date = $('#date').val() ?? null;

            if (date != null) {
                date = date.split(' até ');
            }

            $.ajax({
                contentType: 'application/json',
                method: 'GET',
                url: 'http://18.214.175.44:8080/api/dispositivos',
                data: {
                    id_arduino: idArduino,
                    period: date
                },
                timeout: 0,
                success: function (response) {
                    console.log(response);
                    toastr(response.message);
                    let condicao = response.condicao;
                    let avgSmoke = response.medias.avg_smoke.toString().slice(0, 6);
                    let avgHumidity = response.medias.avg_humidity.toString().slice(0, 6);
                    let avgCo = response.medias.avg_co.toString().slice(0, 6);
                    let avgTemperature = response.medias.avg_temperature.toString().slice(0, 4);
                    let avgCo2 = response.medias.avg_co2.toString().slice(0, 6);
                    let condicaoIcon = '';

                    clear();

                    if (condicao.status == 'Bom') {
                        $('.condicao-alert').addClass('alert-success');
                        condicaoIcon = '<i class="fa fa-check"></i>&nbsp; ';
                    } else if (condicao.status == 'Moderado') {
                        $('.condicao-alert').addClass('alert-warning');
                        condicaoIcon = '<i class="fa fa-warning"></i>&nbsp; ';
                    } else {
                        $('.condicao-alert').addClass('alert-danger');
                        condicaoIcon = '<i class="fa fa-times"></i>&nbsp; ';
                    }

                    $('.condicao').html(condicaoIcon + condicao.message);

                    $('.smoke-avg').html(avgSmoke + ' ppm');
                    $('.smoke-avg-card').addClass('text-bg-primary');
                    $('.progress-smoke').addClass('bg-primary');

                    $('.humidity-avg').html(avgHumidity + ' %');

                    if (avgHumidity >= 40 && avgHumidity <= 70) {
                        $('.humidity-avg-card').addClass('text-bg-success');
                        $('.progress-humidity').addClass('bg-success');
                        $('.progress-humidity').addClass('text-light');
                    } else if (avgHumidity <= 20) {
                        $('.humidity-avg-card').addClass('text-bg-danger');
                        $('.progress-humidity').addClass('bg-danger');
                        $('.progress-humidity').addClass('text-light');
                    } else {
                        $('.humidity-avg-card').addClass('text-bg-warning');
                        $('.progress-humidity').addClass('bg-warning');
                        $('.progress-humidity').addClass('text-dark');
                    }

                    if (avgCo < 0.9) {
                        $('.co-avg-card').addClass('text-bg-success');
                        $('.progress-co').addClass('bg-success');
                        $('.progress-humidity').addClass('text-light');
                    } else if (avgCo >= 0.9 && avgCo <= 1.1) {
                        $('.co-avg-card').addClass('text-bg-warning');
                        $('.progress-co').addClass('bg-warning');
                        $('.progress-humidity').addClass('text-dark');
                    } else {
                        $('.co-avg-card').addClass('text-bg-danger');
                        $('.progress-co').addClass('bg-danger');
                        $('.progress-humidity').addClass('text-light');
                    }

                    $('.co-avg').html(avgCo + ' ppm');

                    if (avgTemperature >= 10 && avgTemperature <= 30) {
                        $('.temperature-avg-card').addClass('text-bg-success');
                        $('.progress-temperature').addClass('bg-success');
                    } else {
                        $('.temperature-avg-card').addClass('text-bg-danger');
                        $('.progress-temperature').addClass('bg-danger');
                    }

                    $('.temperature-avg').html(avgTemperature + ' ºC');

                    if (avgCo2 < 1) {
                        $('.co2-avg-card').addClass('text-bg-success');
                        $('.progress-co2').addClass('bg-success');
                        $('.progress-co2').addClass('text-light');
                    }  else if (avgCo2 >= 1 && avgCo2 <= 5) {
                        $('.co2-avg-card').addClass('text-bg-warning');
                        $('.progress-co2').addClass('bg-warning');
                        $('.progress-co2').addClass('text-dark');
                    } else {
                        $('.co2-avg-card').addClass('text-bg-danger');
                        $('.progress-co2').addClass('bg-danger');
                        $('.progress-co2').addClass('text-light');
                    }

                    $('.co2-avg').html(avgCo2 + ' ppm');

                    let widthAvgHumidity = avgHumidity;
                    let widthAvgTemperature = avgTemperature / 30 * 100;
                    let widthAvgSmoke = avgSmoke;
                    let widthAvgCo = avgCo / 1.1 * 100;
                    let widthAvgCo2 = avgCo2 / 5 * 100;

                    widthAvgTemperature = widthAvgTemperature > 100 ? 100 : widthAvgTemperature;
                    widthAvgHumidity = widthAvgHumidity > 100 ? 100 : widthAvgHumidity;
                    widthAvgSmoke = widthAvgSmoke > 100 ? 100 : widthAvgSmoke;
                    widthAvgCo = widthAvgCo > 100 ? 100 : widthAvgCo;
                    widthAvgCo2 = widthAvgCo2 > 100 ? 100 : widthAvgCo2;

                    $('.progress-temperature').attr('style', `width: ${widthAvgTemperature}%`);
                    $('.progress-temperature').html(`${avgTemperature} ºC`);

                    $('.progress-humidity').attr('style', `width: ${widthAvgHumidity}%`);
                    $('.progress-humidity').html(`${avgHumidity} %`);

                    $('.progress-smoke').attr('style', `width: ${widthAvgSmoke}%`);
                    $('.progress-smoke').html(`${avgSmoke} ppm`);

                    $('.progress-co').attr('style', `width: ${widthAvgCo}%`);
                    $('.progress-co').html(`${avgCo} ppm`);

                    $('.progress-co2').attr('style', `width: ${widthAvgCo2}%`);
                    $('.progress-co2').html(`${avgCo2} ppm`);

                    $('#overlay').addClass('overlay-hidden');
                },
                error: function (error) {
                    console.error(error);
                    toastr('Não há métricas para os parâmetros informados', 'danger');
                    clear();

                    $('.condicao').html('Não há dados');
                    $('.smoke-avg').html('Não há dados');
                    $('.humidity-avg').html('Não há dados');
                    $('.co-avg').html('Não há dados');
                    $('.co2-avg').html('Não há dados');
                    $('.temperature-avg').html('Não há dados');

                    $('#overlay').addClass('overlay-hidden');
                }
            });
        });

        function toastr(message, type = "success") {
            $.notify({message: message}, {
                type: type,
                allow_dismiss: false,
                newest_on_top: true,
            });
        }

        function clear() {
            $('.condicao').html('');
            $('.smoke-avg').html('');
            $('.humidity-avg').html('');
            $('.co-avg').html('');
            $('.co2-avg').html('');
            $('.temperature-avg').html('');

            $('.progress-temperature').html('');
            $('.progress-humidity').html('');
            $('.progress-smoke').html('');
            $('.progress-co').html('');
            $('.progress-co2').html('');

            $('.progress-temperature').attr('style', 'width: 0%');
            $('.progress-humidity').attr('style', 'width: 0%');
            $('.progress-smoke').attr('style', 'width: 0%');
            $('.progress-co').attr('style', 'width: 0%');
            $('.progress-co2').attr('style', 'width: 0%');

            $('.condicao-alert').removeClass('alert-success');
            $('.condicao-alert').removeClass('alert-warning');
            $('.condicao-alert').removeClass('alert-danger');

            $('.smoke-avg-card').removeClass('text-bg-primary');
            $('.smoke-avg-card').removeClass('text-bg-success');
            $('.smoke-avg-card').removeClass('text-bg-warning');
            $('.smoke-avg-card').removeClass('text-bg-danger');

            $('.humidity-avg-card').removeClass('text-bg-primary');
            $('.humidity-avg-card').removeClass('text-bg-success');
            $('.humidity-avg-card').removeClass('text-bg-warning');
            $('.humidity-avg-card').removeClass('text-bg-danger');

            $('.co-avg-card').removeClass('text-bg-primary');
            $('.co-avg-card').removeClass('text-bg-success');
            $('.co-avg-card').removeClass('text-bg-warning');
            $('.co-avg-card').removeClass('text-bg-danger');

            $('.temperature-avg-card').removeClass('text-bg-primary');
            $('.temperature-avg-card').removeClass('text-bg-success');
            $('.temperature-avg-card').removeClass('text-bg-warning');
            $('.temperature-avg-card').removeClass('text-bg-danger');

            $('.co2-avg-card').removeClass('text-bg-primary');
            $('.co2-avg-card').removeClass('text-bg-success');
            $('.co2-avg-card').removeClass('text-bg-warning');
            $('.co2-avg-card').removeClass('text-bg-danger');

            $('.progress-temperature').removeClass('bg-success');
            $('.progress-temperature').removeClass('bg-danger');
            $('.progress-temperature').removeClass('text-light');
            $('.progress-temperature').removeClass('text-dark');

            $('.progress-humidity').removeClass('bg-success');
            $('.progress-humidity').removeClass('bg-warning');
            $('.progress-humidity').removeClass('bg-danger');
            $('.progress-humidity').removeClass('text-light');
            $('.progress-humidity').removeClass('text-dark');

            $('.progress-smoke').removeClass('bg-primary');

            $('.progress-co').removeClass('bg-success');
            $('.progress-co').removeClass('bg-warning');
            $('.progress-co').removeClass('bg-danger');
            $('.progress-co').removeClass('text-light');
            $('.progress-co').removeClass('text-dark');

            $('.progress-co2').removeClass('bg-success');
            $('.progress-co2').removeClass('bg-warning');
            $('.progress-co2').removeClass('bg-danger');
            $('.progress-co2').removeClass('text-light');
            $('.progress-co2').removeClass('text-dark');
        }
    </script>
  </body>
</html>
